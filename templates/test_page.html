<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ test.title }}</title>
...


<style>
/* ====== Ø§Ù„Ø£Ø³Ø§Ø³: Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ ====== */
body {
    font-family: 'Cairo', Arial, sans-serif;
    background: #f0f4f8;
    margin: 0;
    padding: 0;
}

/* â­ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± (Ù…ÙˆØ¨Ø§ÙŠÙ„) */
#topbar {
    background: #2193b0;
    color: white;
    padding: 12px 14px;
    display: flex;
    flex-direction: column;
    gap: 6px;
    justify-content: center;
    align-items: flex-start;
    font-size: 15px;
    font-weight: bold;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}

.topbar-left span,
.topbar-right span {
    margin: 0 4px;
}

/* Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø±: Ø¹Ù…ÙˆØ¯ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
.container {
    display: flex;
    flex-direction: column;
    gap: 14px;
    margin: 10px auto 0 auto;
    max-width: 100%;
    padding: 10px;
    box-sizing: border-box;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø© / Ø§Ù„ÙÙŠØ¯ÙŠÙˆ â€” Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© */
#myImageBox,
video#myVideo {
    width: 100%;
    max-width: 100%;
    height: auto;
    min-height: 180px;
    border-radius: 12px;
    border: 3px solid #2193b0;
    background: #eaf6fb;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    box-sizing: border-box;
}

#myImage {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª â€” Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
.options {
    width: 100%;
    background: #ffffff;
    padding: 16px 12px 18px;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-sizing: border-box;
}

#questionTitle {
    font-size: 18px;
    text-align: center;
    margin: 0 0 6px;
    line-height: 1.4;
}

/* Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ / Ø§Ù„Ø³Ø§Ø¨Ù‚ (Ù…ÙˆØ¨Ø§ÙŠÙ„) */
#nextBtn,
#prevBtn {
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 14px;
}

#nextBtn {
    background: #007bff;
    color: white;
    margin-left: auto;
}

#prevBtn {
    background: #6c757d;
    color: white;
    margin-right: auto;
}

#navButtons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
}

/* Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ */
.option {
    padding: 10px;
    border: 1.3px solid #2193b0;
    background: #fff;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    text-align: right;
    line-height: 1.3;
}
.option:hover {
    background: #eaf6fb;
}

.option.correct {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
}
.option.wrong {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
}

/* Ù…ØªØ¹Ø¯Ø¯ */
.options label {
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    border: 1.3px solid #2193b0;
    cursor: pointer;
    display: flex;
    gap: 8px;
    align-items: center;
    font-size: 15px;
    line-height: 1.3;
}
.options label.correct {
    background: #d4edda;
    border-color: #28a745;
}
.options label.wrong {
    background: #f8d7da;
    border-color: #dc3545;
}
.options label.missed-correct {
    background: #d4edda;
    animation: missedBlink 0.4s ease-in-out 6;
}

@keyframes missedBlink {
    0%, 100% { background: #d4edda; }
    50%      { background: #fff3cd; }
}

/* Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆÙƒØ³ */
.options input[type=checkbox] {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Ø²Ø± ØªØ­Ù‚Ù‚ */
.submit-btn {
    padding: 10px;
    background: #28a745;
    color: white;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 15px;
    margin-top: 6px;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† */
#resultsBox {
    display: none;
    text-align: center;
    margin-top: 14px;
}

.action-btn {
    padding: 8px 14px;
    margin: 0 4px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
}

.action-btn-primary {
    background: #28a745;
    color: #fff;
}

.action-btn-secondary {
    background: #ffffff;
    color: #007bff;
    border: 1px solid #007bff;
}

/* Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø£Ø³Ø¨Ù‚ÙŠØ© */
.order-badge {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    margin-right: 4px;
    color: white;
    font-size: 12px;
}

.order-badge-correct { background: #28a745; }
.order-badge-wrong   { background: #dc3545; }
.order-badge-missed  { background: #17a2b8; }

/* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨) */
.result-circle {
    width: 190px;
    height: 190px;
    border-radius: 50%;
    background: #f0f0f0;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 18px rgba(0,0,0,0.2);
    overflow: hidden;
    position: relative;
}

.result-number {
    position: absolute;
    top: 8px;
    right: 0;
    left: 0;
    text-align: center;
    font-size: 34px;
    font-weight: bold;
    color: #333;
    text-shadow: 0 0 4px rgba(255,255,255,0.8);
}

.result-circle img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Ø¨ÙˆØ¨ Ø£Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© */
.result-popup {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* ====== Ø¯ÙŠØ³ÙƒØªÙˆØ¨ Ùˆ Ø´Ø§Ø´Ø§Øª Ø£ÙƒØ¨Ø± Ù…Ù† 768px ====== */
@media (min-width: 768px) {
    #topbar {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        font-size: 17px;
        padding: 16px 24px;
    }

    .container {
        flex-direction: row;
        max-width: 950px;
        margin-top: 20px;
        gap: 24px;
    }

    #myImageBox,
    video#myVideo {
        width: 420px;
        height: 320px;
    }

    .options {
        max-width: 420px;
        padding: 22px 18px;
        gap: 14px;
    }

    #questionTitle {
        font-size: 20px;
        text-align: right;
    }

    .option,
    .options label {
        font-size: 17px;
        padding: 12px;
    }

    #nextBtn,
    #prevBtn {
        font-size: 15px;
        padding: 9px 14px;
    }

    .result-circle {
        width: 260px;
        height: 260px;
    }

    .result-number {
        font-size: 46px;
        top: 12px;
    }
}
</style>

</head>
<body>

<!-- â­ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<div id="topbar">
    <div class="topbar-left">
        <span>ğŸ {{ test.title }}</span>
    </div>

    <div class="topbar-right">
        <span>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: <span id="totalQuestions"></span></span>
        <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="remainingQuestions"></span></span>

        <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
        <span id="topbarScore" style="display:none;">
            | âœ… <span id="topCorrect"></span>
            | âŒ <span id="topWrong"></span>
        </span>
    </div>
</div>

<div class="container">
{% if test.type == "image" %}
    <div id="myImageBox"><img id="myImage" src="" /></div>
{% elif test.type == "video" %}
    <video id="myVideo" controls><source id="videoSource"></video>
{% endif %}

    <div class="options">
    <h3 id="questionTitle"></h3>
    <div id="optionsList"></div>

    <!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ / Ø§Ù„ØªØ§Ù„ÙŠ ÙÙŠ Ù†ÙØ³ Ø§Ù„ØµÙ -->
    <div id="navButtons">
        <button id="prevBtn">â¬… Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
    </div>

    
</div>

    <!-- â¬‡ï¸ Ù‡Ù†Ø§ ÙÙ‚Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†ØŒ Ø¨Ø¯ÙˆÙ† Ù†Øµ ØµØ­ÙŠØ­/Ø®Ø§Ø·Ø¦ -->
<div id="resultsBox">
    <!-- Ù‡Ù†Ø§ Ø±Ø­ Ù†Ø±Ø³Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¨Ø§Ù„Ù€ JS Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† -->
    <div id="finalResult"></div>

    <button id="resetBtn" class="action-btn action-btn-primary">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
    <button id="backBtn" class="action-btn action-btn-secondary">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
</div>


<script>
const testType = "{{ test.type }}";
const questions = {{ test.questions | tojson }};
const totalQuestions = questions.length;

let current = 0;
let correctCount = 0;
let wrongCount = 0;
let answered = Array(questions.length).fill(false);
let selectedAnswers = Array(questions.length).fill(null);

function arraysEqual(a, b) {
    if (!Array.isArray(a) || !Array.isArray(b)) return false;
    if (a.length !== b.length) return false;
    return a.every(x => b.includes(x)) && b.every(x => a.includes(x));
}

// ğŸ”¢ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
function updateRemaining() {
    const answeredCount = answered.filter(x => x).length;
    const remaining = totalQuestions - answeredCount;
    const remEl = document.getElementById("remainingQuestions");
    if (remEl) remEl.textContent = remaining;
}

function loadQuestion(idx) {
    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    if (testType == "image") {
        const img = document.getElementById("myImage");
        if (img) img.src = "/static/" + questions[idx].image;
    } else if (testType == "video") {
        const src = document.getElementById("videoSource");
        const video = document.getElementById("myVideo");
        if (src && video) {
            src.src = "/static/" + questions[idx].video;
            video.load();
            video.play();
        }
    }

    // Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„
    document.getElementById("questionTitle").textContent = questions[idx].question;

    const optionsDiv = document.getElementById("optionsList");
    optionsDiv.innerHTML = "";

    let correct = questions[idx].correct;
    let isMulti = Array.isArray(correct) && correct.length > 1;
    let isOrder = isMulti && questions[idx].order === true; // Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„ÙˆÙŠØ©

    // ğŸŸ¡ Ø­Ø§Ù„Ø© Ø³Ø¤Ø§Ù„ Ø£ÙˆÙ„ÙˆÙŠØ©
    if (isOrder) {
        if (!Array.isArray(selectedAnswers[idx])) selectedAnswers[idx] = [];

        questions[idx].options.forEach((opt, i) => {
            const btn = document.createElement("button");
            btn.className = "option";

            const userPos = selectedAnswers[idx].indexOf(i);
            const textSpan = document.createElement("span");
            textSpan.textContent = opt + (userPos !== -1 ? ` (ØªØ±ØªÙŠØ¨Ùƒ: ${userPos + 1})` : "");
            btn.appendChild(textSpan);

            btn.disabled = answered[idx];

            btn.onclick = () => {
                if (answered[idx]) return;
                if (!selectedAnswers[idx].includes(i)) {
                    selectedAnswers[idx].push(i);
                }
                loadQuestion(idx);
            };

            optionsDiv.appendChild(btn);
        });

        const submitBtn = document.createElement("button");
        submitBtn.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
        submitBtn.className = "submit-btn";
        submitBtn.disabled = answered[idx];
        submitBtn.onclick = function () {
            if (!Array.isArray(selectedAnswers[idx]) || selectedAnswers[idx].length === 0) {
                alert("Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            checkAnswer(selectedAnswers[idx].slice());
        };
        optionsDiv.appendChild(submitBtn);

    // ğŸŸ¢ Ø­Ø§Ù„Ø© Ù…ØªØ¹Ø¯Ø¯ Ø¹Ø§Ø¯ÙŠ (checkbox)
    } else if (isMulti) {
        if (!Array.isArray(selectedAnswers[idx])) selectedAnswers[idx] = [];

        questions[idx].options.forEach((opt, i) => {
            const label = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.value = i;
            cb.disabled = answered[idx];
            cb.checked = selectedAnswers[idx].includes(i);

            cb.onchange = function () {
                if (!Array.isArray(selectedAnswers[idx])) selectedAnswers[idx] = [];
                if (cb.checked && !selectedAnswers[idx].includes(i)) {
                    selectedAnswers[idx].push(i);
                } else if (!cb.checked && selectedAnswers[idx].includes(i)) {
                    selectedAnswers[idx] = selectedAnswers[idx].filter(x => x !== i);
                }
            };

            label.appendChild(cb);
            label.appendChild(document.createTextNode(opt));
            optionsDiv.appendChild(label);
        });

        const submitBtn = document.createElement("button");
        submitBtn.textContent = "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©";
        submitBtn.className = "submit-btn";
        submitBtn.disabled = answered[idx];
        submitBtn.onclick = function () {
            if (!Array.isArray(selectedAnswers[idx]) || selectedAnswers[idx].length === 0) {
                alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
                return;
            }
            checkAnswer(selectedAnswers[idx].slice());
        };
        optionsDiv.appendChild(submitBtn);

    // ğŸ”µ Ø­Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ§Ø­Ø¯
    } else {
        questions[idx].options.forEach((opt, i) => {
            const btn = document.createElement("button");
            btn.className = "option";
            btn.textContent = opt;
            btn.disabled = answered[idx];

            btn.onclick = () => checkAnswer(i);

            if (answered[idx]) {
                btn.style.opacity = "0.7";
                btn.style.cursor = "not-allowed";
                if (selectedAnswers[idx] === i) {
                    btn.classList.add(questions[idx].correct.includes(i) ? "correct" : "wrong");
                }
                if (questions[idx].correct.includes(i) && selectedAnswers[idx] !== i) {
                    btn.classList.add("correct");
                }
            }

            optionsDiv.appendChild(btn);
        });
    }

    // Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ/Ø§Ù„Ø³Ø§Ø¨Ù‚
    const nextBtn = document.getElementById("nextBtn");
    const prevBtn = document.getElementById("prevBtn");

    nextBtn.style.display = "none";
    prevBtn.style.display = idx > 0 ? "inline-block" : "none";

    if (answered[idx]) {
        nextBtn.style.display = "inline-block";
        if (idx === questions.length - 1) {
            nextBtn.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©";
            nextBtn.onclick = showResults;
        } else {
            nextBtn.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ â–¶";
            nextBtn.onclick = goNext;
        }
    }

    updateRemaining();
}

function checkAnswer(selected) {
    if (answered[current]) return;

    let correctAnswer = questions[current].correct;
    let isMulti = Array.isArray(correctAnswer) && correctAnswer.length > 1;
    let isOrder = isMulti && questions[current].order === true;
    let userAnswer;

    // ğŸŸ¡ Ø£Ø³Ø¨Ù‚ÙŠØ©
    if (isOrder) {
        userAnswer = Array.isArray(selected) ? selected.slice() : [];
        const buttons = document.querySelectorAll('#optionsList .option');

        buttons.forEach((btn, index) => {
            btn.classList.remove('correct', 'wrong');
            btn.style.pointerEvents = "none";

            const correctPos = correctAnswer.indexOf(index);
            const userPos = userAnswer.indexOf(index);
            const optionText = questions[current].options[index];

            btn.innerHTML = "";

            const wrapper = document.createElement("span");
            wrapper.style.display = "flex";
            wrapper.style.flexWrap = "wrap";
            wrapper.style.alignItems = "center";
            wrapper.style.gap = "6px";

            // Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if (userPos !== -1 || correctPos !== -1) {
                const mainBadge = document.createElement("span");
                mainBadge.classList.add("order-badge");

                if (userPos !== -1) {
                    mainBadge.textContent = userPos + 1;
                    if (correctPos !== -1 && userPos === correctPos) {
                        mainBadge.classList.add("order-badge-correct");
                        btn.classList.add("correct");
                    } else {
                        mainBadge.classList.add("order-badge-wrong");
                        btn.classList.add("wrong");
                    }
                } else if (userPos === -1 && correctPos !== -1) {
                    mainBadge.textContent = correctPos + 1;
                    mainBadge.classList.add("order-badge-missed");
                    btn.classList.add("correct");
                }

                wrapper.appendChild(mainBadge);
            }

            const textSpan = document.createElement("span");
            textSpan.textContent = optionText + " ";
            wrapper.appendChild(textSpan);

            const extraSpan = document.createElement("span");
            extraSpan.style.fontSize = "14px";

            if (userPos !== -1 && correctPos !== -1) {
                extraSpan.appendChild(document.createTextNode("ØªØ±ØªÙŠØ¨Ùƒ: " + (userPos + 1) + "ØŒ Ø§Ù„ØµØ­ÙŠØ­: "));

                const correctBadgeInline = document.createElement("span");
                correctBadgeInline.classList.add("order-badge", "order-badge-correct");
                correctBadgeInline.textContent = correctPos + 1;

                extraSpan.appendChild(correctBadgeInline);
            } else if (userPos !== -1 && correctPos === -1) {
                extraSpan.textContent = " (ØªØ±ØªÙŠØ¨Ùƒ: " + (userPos + 1) + "ØŒ Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø¶Ù…Ù† Ø§Ù„Ø£Ø³Ø¨Ù‚ÙŠØ©)";
            } else if (userPos === -1 && correctPos !== -1) {
                extraSpan.appendChild(document.createTextNode(" (ÙƒØ§Ù† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„ØªØ±ØªÙŠØ¨ "));
                const correctBadgeInline = document.createElement("span");
                correctBadgeInline.classList.add("order-badge", "order-badge-correct");
                correctBadgeInline.textContent = correctPos + 1;
                extraSpan.appendChild(correctBadgeInline);
                extraSpan.appendChild(document.createTextNode(")"));
            }

            wrapper.appendChild(extraSpan);
            btn.appendChild(wrapper);
        });

        let isCorrect = arraysEqual(userAnswer, correctAnswer);
        if (isCorrect) correctCount++;
        else wrongCount++;

        selectedAnswers[current] = userAnswer;

    // ğŸŸ¢ Ù…ØªØ¹Ø¯Ø¯ Ø¹Ø§Ø¯ÙŠ
    } else if (isMulti) {
        userAnswer = Array.isArray(selected) ? selected.slice().sort() : [];
        let correctSorted = correctAnswer.slice().sort();
        let isCorrect = arraysEqual(userAnswer, correctSorted);

        const checkboxes = document.querySelectorAll('#optionsList input[type="checkbox"]');

        checkboxes.forEach((cb, idx) => {
            const label = cb.parentNode;
            const isUserSelected = userAnswer.includes(idx);
            const isCorrectOpt = correctAnswer.includes(idx);

            label.classList.remove("correct", "wrong", "missed-correct");

            if (isUserSelected && isCorrectOpt) {
                label.classList.add("correct");
            } else if (isUserSelected && !isCorrectOpt) {
                label.classList.add("wrong");
            } else if (!isUserSelected && isCorrectOpt) {
                label.classList.add("correct", "missed-correct");
            }

            cb.disabled = true;
        });

        if (isCorrect) correctCount++;
        else wrongCount++;

        selectedAnswers[current] = userAnswer;

    // ğŸ”µ Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯
    } else {
        userAnswer = selected;
        selectedAnswers[current] = selected;

        const btns = document.querySelectorAll("#optionsList .option");
        if (correctAnswer.includes(selected)) {
            btns[selected].classList.add("correct");
            correctCount++;
        } else {
            btns[selected].classList.add("wrong");
            correctAnswer.forEach(idx => btns[idx].classList.add("correct"));
            wrongCount++;
        }
        btns.forEach(btn => btn.style.pointerEvents = "none");
    }

    answered[current] = true;
    updateRemaining();

    const nextBtn = document.getElementById("nextBtn");
    nextBtn.style.display = "inline-block";

    if (current === questions.length - 1) {
        nextBtn.textContent = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©";
        nextBtn.onclick = showResults;
    } else {
        nextBtn.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ â–¶";
        nextBtn.onclick = goNext;
    }
}

function showResults() {
    const score = correctCount;

    // Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„ØµÙˆØ±Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§)
    let gifSrc = "";

    if (score < 10) {
        gifSrc = "/static/fotos/gif.gif";
    } else if (score < 20) {
        gifSrc = "/static/fotos/gif.gif";
    } else if (score < 30) {
        gifSrc = "/static/fotos/gif.gif";
    } else {
        gifSrc = "/static/fotos/gif1.gif";
    }

    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù…Ø«Ù„Ø§Ù‹ 70% ÙÙ…Ø§ ÙÙˆÙ‚ Ù†Ø¬Ø§Ø­)
    const successSound = document.getElementById("successSound");
    const failSound = document.getElementById("failSound");
    const total = questions.length;
    const ratio = total > 0 ? score / total : 0;

    if (successSound && failSound) {
        if (ratio >= 0.7) {
            // Ù†Ø¬Ø§Ø­
            failSound.pause();
            failSound.currentTime = 0;
            successSound.currentTime = 0;
            successSound.play().catch(() => {});
        } else {
            // Ù†ØªÙŠØ¬Ø© Ø¶Ø¹ÙŠÙØ©
            successSound.pause();
            successSound.currentTime = 0;
            failSound.currentTime = 0;
            failSound.play().catch(() => {});
        }
    }

    // ğŸ”µ Ø¹Ø±Ø¶ Popup ÙŠØºØ·ÙŠ Ø§Ù„Ø´Ø§Ø´Ø©
    const popup = document.getElementById("popupContainer");
    if (popup) {
        popup.innerHTML = `
            <div class="result-popup">
                <div class="result-circle">
                    <img src="${gifSrc}">
                    <div class="result-number">${score}</div>
                </div>
            </div>
        `;
    }

    // â³ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ: Ù†Ø®ÙÙŠ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ ÙˆÙ†Ø¸Ù‡Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·
    setTimeout(() => {
        if (popup) popup.innerHTML = "";

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ
        const topScore = document.getElementById("topbarScore");
        const topCorrect = document.getElementById("topCorrect");
        const topWrong = document.getElementById("topWrong");

        if (topScore && topCorrect && topWrong) {
            topCorrect.textContent = correctCount;
            topWrong.textContent = wrongCount;
            topScore.style.display = "inline-block";
        }

        // Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙˆØ§Ù„Ø±Ø¬ÙˆØ¹
        const resBox = document.getElementById("resultsBox");
        if (resBox) {
            resBox.style.display = "block";
        }

    }, 5000);

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ (ÙƒÙ…Ø§ Ø¹Ù†Ø¯Ùƒ)
    if (window.fetch) {
        fetch("/finish_test/{{ test.id }}", { method: "POST" })
        .catch(() => {});
    }
}
function resetExam() {
    current = 0;
    correctCount = 0;
    wrongCount = 0;
    answered = Array(questions.length).fill(false);
    selectedAnswers = Array(questions.length).fill(null);

    const topScore = document.getElementById("topbarScore");
    if (topScore) topScore.style.display = "none";

    const resBox = document.getElementById("resultsBox");
    if (resBox) resBox.style.display = "none";

    loadQuestion(current);
}

function goNext() {
    if (current < questions.length - 1) {
        current++;
        loadQuestion(current);
    }
}

function goPrev() {
    if (current > 0) {
        current--;
        loadQuestion(current);
    }
}

window.onload = () => {
    const totalSpan = document.getElementById("totalQuestions");
    if (totalSpan) totalSpan.textContent = totalQuestions;

    loadQuestion(current);

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    prevBtn.onclick = goPrev;
    nextBtn.onclick = goNext;
};


</script>
<!-- Ø£ØµÙˆØ§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
<audio id="successSound" src="/static/sounds/success.mp3" preload="auto"></audio>
<audio id="failSound" src="/static/sounds/fail.mp3" preload="auto"></audio>

<div id="popupContainer"></div>
</body>
</html>


</body>
</html>
